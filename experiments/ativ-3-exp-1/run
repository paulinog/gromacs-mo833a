#!/usr/bin/env bash 
# @file     run
# @author	Guilherme Paulino <ra117119 @students.ic.unicamp.br>

echo "Hi there! I'm now in $PWD"
DIR_ATIV3="${PWD}/${0%/*}"

compile_and_prepare_env() {
    if [[ ! -d build/$1 ]]; then
        source ${DIR_ATIV3}/build.sh $1
    else
        echo "Skip, build/$1 already exists...";
    fi
    source ${DIR_ATIV3}/process_gmx.sh $1
}

run_simulations() {
    GMX="${PWD}/build/$1/bin/gmx"
    DB="${DIR_ATIV3}/data/$1-$(date +%Y%m%d-%H%M%S).log"
    cd ${DIR_ATIV3}/data/$1/
    for i in {1..100}; do
        # time -p ${GMX} mdrun -v -deffnm em >> ${DB}
        ${GMX} mdrun -v -deffnm em >> ${DB}
    done
    cut -d " " -f 5 ${DB} > ${DIR_ATIV3}/$1.csv
}

# Download input files
if [[ ! -d ${DIR_ATIV3}/data ]]; then
    source ${DIR_ATIV3}/download.sh
else
    echo "Skip, download files already there...";
fi

# Compile in Release mode and prepare environment
compile_and_prepare_env Release

# Compile in Debug mode
compile_and_prepare_env Debug

# Run simulation in Release mode and measure time
run_simulations Release

# Run simulation in Debug mode and measure time
run_simulations Debug
